app-id: org.freedesktop.weston
runtime: org.freedesktop.Platform
runtime-version: "21.08"
sdk: org.freedesktop.Sdk
command: weston
rename-desktop-file: weston.desktop
rename-icon: wayland
finish-args:
- --socket=wayland
- --device=dri
- --filesystem=/run/user/
- --talk-name=org.freedesktop.Flatpak
cleanup:
- /bin/checkmk
- /bin/libevdev-tweak-device
- /bin/libinput
- /bin/mouse-dpi-tool
- /bin/mtdev-test
- /bin/touchpad-edge-detector
- /etc
- /include
- /lib/*.a
- /lib/*.la
- /lib/cmake
- /lib/debug
- /lib/pkgconfig
- /lib/udev
- /libexec/libinput
- /share/libweston-10
- /share/man
- /share/pkgconfig
- /share/zsh

modules:
- name: mtdev
  sources:
  - type: git
    url: http://bitmath.org/git/mtdev.git
    tag: "v1.1.6"
    # fatal: dumb http transport does not support shallow capabilities
    disable-shallow-clone: true
  buildsystem: autotools

- name: check
  sources:
  - type: git
    url: https://github.com/libcheck/check.git
    tag: "0.15.2"
  buildsystem: cmake-ninja
  builddir: true

- name: libevdev
  sources:
  - type: git
    url: https://gitlab.freedesktop.org/libevdev/libevdev.git
    tag: "libevdev-1.12.0"
  buildsystem: meson
  builddir: true
  config-opts:
  - -Dtests=disabled
  - -Ddocumentation=disabled

- name: libinput
  sources:
  - type: git
    url: https://gitlab.freedesktop.org/libinput/libinput.git
    tag: "1.19.3"
  buildsystem: meson
  builddir: true
  config-opts:
  - -Dlibwacom=false
  - -Ddebug-gui=false
  - -Dtests=false

- name: seat
  sources:
  - type: git
    url: https://git.sr.ht/~kennylevinsen/seatd
    tag: "0.6.3"
  buildsystem: meson
  builddir: true

- name: weston
  sources:
  - type: git
    url: https://gitlab.freedesktop.org/wayland/weston.git
    tag: "10.0.0"
  buildsystem: meson
  builddir: true
  config-opts:
  - -Dbackend-rdp=false
  - -Dxwayland=false
  - -Dsystemd=false
  - -Dpipewire=false
  - -Dshell-fullscreen=false
  - -Dshell-ivi=false
  - -Dshell-kiosk=false
  - -Dcolor-management-lcms=false
  - -Dcolor-management-colord=false
  - -Dlauncher-logind=true
  - -Dlauncher-libseat=true
  - -Dwcap-decode=false
  - -Dtest-junit-xml=false
  - -Dtest-gl-renderer=false
  post-install:
  # launcher
  - install -Dm644 /app/share/wayland-sessions/weston.desktop /app/share/applications/weston.desktop
  # SVG icon, "is not a valid icon: Format not recognized"
  # - install -Dm644 /app/share/weston/wayland.svg /app/share/icons/hicolor/scalable/apps/wayland.svg
  # PNG icon
  - install -Dm644 /app/share/weston/wayland.png /app/share/icons/hicolor/128x128/apps/wayland.png
  # set icon
  - desktop-file-edit --set-icon=wayland /app/share/applications/weston.desktop

- name: appstream
  sources:
  - type: file
    path: org.freedesktop.weston.appdata.xml
  buildsystem: simple
  build-commands:
  # AppStream meta data
  - install -Dm644 org.freedesktop.weston.appdata.xml /app/share/metainfo/org.freedesktop.weston.appdata.xml

- name: weston-seatd
  sources:
  - type: script
    dest-filename: weston-seatd
    commands:
    - export SEATD_LOGLEVEL=debug
    - seatd-launch -- weston
  buildsystem: simple
  build-commands:
  - install -Dm755 weston-seatd /app/bin/weston-seatd

- name: weston-logind
  sources:
  - type: script
    dest-filename: weston-logind
    commands:
    - dbus-launch weston
  buildsystem: simple
  build-commands:
  - install -Dm755 weston-logind /app/bin/weston-logind

- name: shell-wrapper
  sources:
  - type: script
    dest-filename: shell-wrapper
    commands:
    - flatpak-spawn --host "$SHELL" "$@"
  buildsystem: simple
  build-commands:
  - install -Dm755 shell-wrapper /app/bin/shell-wrapper

- name: terminal-wrapper
  sources:
  - type: script
    dest-filename: weston-terminal
    commands:
    - export SHELL=bash
    - weston-terminal-sandboxed --shell=/app/bin/shell-wrapper
  buildsystem: simple
  build-commands:
  # rename original executable
  - mv /app/bin/weston-terminal /app/bin/weston-terminal-sandboxed
  # install wrapper script
  - install -Dm755 weston-terminal /app/bin/weston-terminal
